<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subordina√ß√µes - Controle de CDs</title>
  <style>
    body {font-family:"Poppins",sans-serif;background:#fff;color:#333;margin:0;padding:20px;}
    h1{text-align:center;color:#0066cc;margin-bottom:20px;}
    .top-bar{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:20px;gap:10px;}
    input[type="file"],select,input[type="text"]{padding:8px;border-radius:6px;border:1px solid #ccc;}
    button{padding:8px 15px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:0.3s;color:white;}
    .importar{background-color:#0077b6;}
    .apagar{background-color:#d62828;}
    .voltar{background-color:#666;}
    .salvar{background-color:#2a9d8f;}
    button:hover{opacity:0.8;}
    table{width:100%;border-collapse:collapse;margin-top:15px;}
    th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left;}
    th{background:#f5f5f5;color:#333;}
    tr:hover{background:#f1f1f1;}
    td button{padding:4px 10px;border:none;border-radius:4px;font-size:0.8rem;color:#fff;margin-right:4px;}
    .editar{background-color:#2a9d8f;}
    .excluir{background-color:#e63946;}
    .tabela-container{max-height:450px;overflow-y:auto;}
    .info{margin-top:15px;font-weight:600;}
    .toast{position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:10px 16px;border-radius:6px;opacity:0;transition:0.4s;z-index:1000;}
    .toast.show{opacity:1;}
    #acoesImport{display:none;gap:10px;margin-top:10px;}
  </style>
</head>
<body>
  <h1>üìã Subordina√ß√µes - Diretor / GRC / CD</h1>

  <div class="top-bar">
    <input type="file" id="inputCSV" accept=".csv">
    <button class="importar" id="btnVisualizar">üëÄ Visualizar CSV</button>
    <button class="apagar" id="btnApagar">üóëÔ∏è Apagar Todos</button>
    <button class="voltar" onclick="window.location.href='index.html'">‚¨ÖÔ∏è Voltar</button>
  </div>

  <div>
    <select id="filtroDiretor"><option value="">Todos os Diretores</option></select>
    <select id="filtroGrc"><option value="">Todos os GRCs</option></select>
    <input type="text" id="pesquisa" placeholder="Pesquisar CD...">
  </div>

  <div id="acoesImport">
    <button class="salvar" id="btnSalvarBanco">‚úÖ Cadastrar no Banco</button>
  </div>

  <div class="tabela-container">
    <table>
      <thead>
        <tr>
          <th>Diretor</th>
          <th>GRC</th>
          <th>CD</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaSub"></tbody>
    </table>
  </div>

  <p class="info">Total de CDs cadastrados: <span id="totalCDs">0</span></p>
  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, deleteDoc, doc } 
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcXTj40CI4fEJOGp2T_ghh3Wwpki4OnW0",
      authDomain: "salasdereunioes-eb91a.firebaseapp.com",
      projectId: "salasdereunioes-eb91a",
      storageBucket: "salasdereunioes-eb91a.firebasestorage.app",
      messagingSenderId: "961898084996",
      appId: "1:961898084996:web:535185ceb0860e1e06e0d1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tabela = document.getElementById("tabelaSub");
    const totalCDs = document.getElementById("totalCDs");
    const filtroDiretor = document.getElementById("filtroDiretor");
    const filtroGrc = document.getElementById("filtroGrc");
    const pesquisa = document.getElementById("pesquisa");
    const toast = document.getElementById("toast");
    const acoesImport = document.getElementById("acoesImport");
    const btnSalvarBanco = document.getElementById("btnSalvarBanco");

    let subordinacoes = [];
    let preVisualizacao = [];

    function toastMsg(texto, cor="#2a9d8f") {
      toast.textContent = texto;
      toast.style.background = cor;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2500);
    }

    async function carregarSubordinacoes() {
      const snap = await getDocs(collection(db, "subordinacoes"));
      subordinacoes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      atualizarTabela(subordinacoes);
      preencherFiltros();
    }

    function atualizarTabela(lista) {
      tabela.innerHTML = "";
      lista.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.diretor || ""}</td>
          <td>${s.grc || ""}</td>
          <td>${s.cd || ""}</td>
          <td>${s.id ? 
            `<button class='editar' onclick="editar('${s.id}')">Editar</button>
             <button class='excluir' onclick="excluir('${s.id}')">Excluir</button>`
           : `<em>Pr√©-visualiza√ß√£o</em>`}</td>
        `;
        tabela.appendChild(tr);
      });
      totalCDs.textContent = lista.length;
    }

    function preencherFiltros() {
      const dirs = [...new Set(subordinacoes.map(s => s.diretor))].sort();
      const grcs = [...new Set(subordinacoes.map(s => s.grc))].sort();
      filtroDiretor.innerHTML = '<option value="">Todos os Diretores</option>' + dirs.map(d => `<option>${d}</option>`).join('');
      filtroGrc.innerHTML = '<option value="">Todos os GRCs</option>' + grcs.map(g => `<option>${g}</option>`).join('');
    }

    window.editar = async (id) => {
      const reg = subordinacoes.find(s => s.id === id);
      if (!reg) return toastMsg("Registro n√£o encontrado", "#d62828");
      const novoDir = prompt("Novo Diretor:", reg.diretor);
      const novoGrc = prompt("Novo GRC:", reg.grc);
      if (novoDir && novoGrc) {
        await setDoc(doc(db, "subordinacoes", id), { diretor: novoDir, grc: novoGrc, cd: reg.cd });
        toastMsg("Registro atualizado!");
        carregarSubordinacoes();
      }
    };

    window.excluir = async (id) => {
      if (!confirm("Excluir este registro?")) return;
      await deleteDoc(doc(db, "subordinacoes", id));
      subordinacoes = subordinacoes.filter(s => s.id !== id);
      atualizarTabela(subordinacoes);
      toastMsg("Registro exclu√≠do!", "#e63946");
    };

    document.getElementById("btnApagar").addEventListener("click", async () => {
      if (!confirm("Deseja realmente apagar TODOS os registros?")) return;
      const promises = subordinacoes.map(s => deleteDoc(doc(db, "subordinacoes", s.id)));
      await Promise.all(promises);
      subordinacoes = [];
      atualizarTabela([]);
      toastMsg("Todos os registros foram removidos!", "#e63946");
    });

    // ‚úÖ VISUALIZAR CSV COM CORRE√á√ÉO DE CABE√áALHOS
    document.getElementById("btnVisualizar").addEventListener("click", () => {
      const file = document.getElementById("inputCSV").files[0];
      if (!file) return toastMsg("Selecione um arquivo CSV primeiro!", "#d62828");
      
      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result;
        const lines = text.replace(/\r/g, '').trim().split("\n");

        // Fun√ß√£o para limpar e padronizar os nomes das colunas
        const normalize = str => str
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .trim()
          .toLowerCase();

        const headers = lines[0].split(",").map(h => normalize(h));
        preVisualizacao = lines.slice(1).map(line => {
          const values = line.split(",").map(v => v.trim());
          const obj = {};
          headers.forEach((h, i) => obj[h] = values[i]);
          return {
            diretor: obj["diretor"] || obj["dir"] || "",
            grc: obj["grc"] || obj["gerente"] || "",
            cd: obj["cd"] || obj["centro"] || ""
          };
        });

        if (preVisualizacao.length === 0) return toastMsg("CSV vazio!", "#d62828");
        atualizarTabela(preVisualizacao);
        acoesImport.style.display = "flex";
        toastMsg("Pr√©-visualiza√ß√£o carregada!");
      };
      reader.readAsText(file, "UTF-8");
    });

    // ‚úÖ CADASTRAR DIRETAMENTE NO FIRESTORE
    btnSalvarBanco.addEventListener("click", async () => {
      if (preVisualizacao.length === 0) return toastMsg("Nada para salvar!", "#d62828");
      toastMsg("Salvando dados...");
      for (const r of preVisualizacao) {
        if (r.cd) {
          const id = r.cd.trim().replace(/\s+/g, "_");
          await setDoc(doc(db, "subordinacoes", id), r);
        }
      }
      acoesImport.style.display = "none";
      preVisualizacao = [];
      toastMsg("Registros salvos com sucesso!");
      carregarSubordinacoes();
    });

    function filtrar() {
      let lista = subordinacoes.filter(s => {
        return (!filtroDiretor.value || s.diretor === filtroDiretor.value) &&
               (!filtroGrc.value || s.grc === filtroGrc.value) &&
               (!pesquisa.value || s.cd.toLowerCase().includes(pesquisa.value.toLowerCase()));
      });
      atualizarTabela(lista);
    }

    filtroDiretor.addEventListener("change", filtrar);
    filtroGrc.addEventListener("change", filtrar);
    pesquisa.addEventListener("input", filtrar);

    carregarSubordinacoes();
  </script>
</body>
</html>
