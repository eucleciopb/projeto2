<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subordina√ß√µes - Controle de CDs</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {font-family:"Poppins",sans-serif;background:#fff;color:#333;margin:0;padding:20px;}
    h1{text-align:center;color:#0066cc;margin-bottom:20px;}
    .top-bar{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:20px;gap:10px;}
    input[type="file"],select,input[type="text"]{padding:8px;border-radius:6px;border:1px solid #ccc;}
    button{padding:8px 15px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:0.3s;color:white;}
    .importar{background-color:#0077b6;}
    .apagar{background-color:#d62828;}
    .voltar{background-color:#666;}
    .salvar{background-color:#2a9d8f;}
    button:hover{opacity:0.8;}
    table{width:100%;border-collapse:collapse;margin-top:15px;}
    th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left;}
    th{background:#f5f5f5;color:#333;}
    tr:hover{background:#f1f1f1;}
    td button{padding:4px 10px;border:none;border-radius:4px;font-size:0.8rem;color:#fff;margin-right:4px;}
    .editar{background-color:#2a9d8f;}
    .excluir{background-color:#e63946;}
    .tabela-container{max-height:450px;overflow-y:auto;}
    .info{margin-top:15px;font-weight:600;}
    .toast{position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:10px 16px;border-radius:6px;opacity:0;transition:0.4s;z-index:1000;}
    .toast.show{opacity:1;}
    #acoesImport{display:none;gap:10px;margin-top:10px;}
    #progressBar {margin-top:15px;width:100%;background:#eee;border-radius:10px;overflow:hidden;display:none;}
    #progressFill {height:18px;background:#2a9d8f;width:0%;text-align:center;color:#fff;font-size:12px;line-height:18px;}

    /* üîí LOGIN */
    #loginOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    #loginBox {
      background: #1e293b;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      text-align: center;
      width: 90%;
      max-width: 320px;
      color: white;
    }
    #loginBox h2 {
      margin-bottom: 20px;
      color: #00b4d8;
    }
    #loginBox select, #loginBox input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: none;
      outline: none;
      font-size: 1rem;
    }
    #loginBox select { background: #f1f1f1; }
    #loginBox input[type="password"] { background: #fff; }
    #loginBtn {
      background: #00b4d8;
      color: white;
      font-weight: 600;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
      width: 100%;
    }
    #loginBtn:hover { background: #0077b6; }
  </style>
</head>
<body>
  <!-- üîí BLOQUEIO DE LOGIN -->
  <div id="loginOverlay">
    <div id="loginBox">
      <h2>üîê Acesso Restrito</h2>
      <select id="usuarioSelect">
        <option value="">Selecione seu nome</option>
        <option value="bruna">Bruna</option>
        <option value="elaine">Elaine</option>
        <option value="euclecio">Euclecio</option>
        <option value="pedro">Pedro</option>
      </select>
      <input type="password" id="senhaInput" placeholder="Senha" />
      <button id="loginBtn">Entrar</button>
      <p id="msgErro" style="color:#f87171;margin-top:10px;"></p>
    </div>
  </div>

  <h1>üìã Subordina√ß√µes - Diretor / GRC / CD</h1>

  <div class="top-bar">
    <input type="file" id="inputExcel" accept=".xlsx, .xls">
    <button class="importar" id="btnVisualizar">üëÄ Visualizar Excel</button>
    <button class="apagar" id="btnApagar">üóëÔ∏è Apagar Todos</button>
    <button class="voltar" onclick="window.location.href='index.html'">‚¨ÖÔ∏è Voltar</button>
  </div>

  <div>
    <select id="filtroDiretor"><option value="">Todos os Diretores</option></select>
    <select id="filtroGrc"><option value="">Todos os GRCs</option></select>
    <input type="text" id="pesquisa" placeholder="Pesquisar CD...">
  </div>

  <div id="acoesImport">
    <button class="salvar" id="btnSalvarBanco">‚úÖ Cadastrar no Banco</button>
  </div>

  <div id="progressBar">
    <div id="progressFill">0%</div>
  </div>

  <div class="tabela-container">
    <table>
      <thead>
        <tr>
          <th>Diretor</th>
          <th>GRC</th>
          <th>CD</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaSub"></tbody>
    </table>
  </div>

  <p class="info">Total de CDs cadastrados: <span id="totalCDs">0</span></p>
  <div id="toast" class="toast"></div>

  <!-- üîí SCRIPT DE LOGIN -->
  <script>
    const senhaPadrao = "Petra25";
    function verificarLogin() {
      const usuario = localStorage.getItem("usuarioLogado");
      const overlay = document.getElementById("loginOverlay");
      const titulo = document.querySelector("h1");
      if (!usuario) overlay.style.display = "flex";
      else {
        overlay.style.display = "none";
        titulo.textContent += ` - ${usuario.charAt(0).toUpperCase() + usuario.slice(1)}`;
      }
    }
    document.getElementById("loginBtn").addEventListener("click", () => {
      const usuario = document.getElementById("usuarioSelect").value;
      const senha = document.getElementById("senhaInput").value;
      const msgErro = document.getElementById("msgErro");
      if (!usuario || !senha) { msgErro.textContent = "Preencha todos os campos!"; return; }
      if (senha !== senhaPadrao) { msgErro.textContent = "Senha incorreta!"; return; }
      localStorage.setItem("usuarioLogado", usuario);
      document.getElementById("loginOverlay").style.display = "none";
      const titulo = document.querySelector("h1");
      titulo.textContent += ` - ${usuario.charAt(0).toUpperCase() + usuario.slice(1)}`;
    });
    verificarLogin();
  </script>

  <!-- üî• FIREBASE SCRIPT ORIGINAL -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, deleteDoc, doc } 
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBcXTj40CI4fEJOGp2T_ghh3Wwpki4OnW0",
      authDomain: "salasdereunioes-eb91a.firebaseapp.com",
      projectId: "salasdereunioes-eb91a",
      storageBucket: "salasdereunioes-eb91a.firebasestorage.app",
      messagingSenderId: "961898084996",
      appId: "1:961898084996:web:535185ceb0860e1e06e0d1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tabela = document.getElementById("tabelaSub");
    const totalCDs = document.getElementById("totalCDs");
    const filtroDiretor = document.getElementById("filtroDiretor");
    const filtroGrc = document.getElementById("filtroGrc");
    const pesquisa = document.getElementById("pesquisa");
    const toast = document.getElementById("toast");
    const acoesImport = document.getElementById("acoesImport");
    const btnSalvarBanco = document.getElementById("btnSalvarBanco");
    const progressBar = document.getElementById("progressBar");
    const progressFill = document.getElementById("progressFill");

    let subordinacoes = [];
    let preVisualizacao = [];

    function toastMsg(texto, cor="#2a9d8f") {
      toast.textContent = texto;
      toast.style.background = cor;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2500);
    }

    async function carregarSubordinacoes() {
      const snap = await getDocs(collection(db, "subordinacoes"));
      subordinacoes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      atualizarTabela(subordinacoes);
      preencherFiltros();
    }

    function atualizarTabela(lista) {
      tabela.innerHTML = "";
      lista.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.diretor || ""}</td>
          <td>${s.grc || ""}</td>
          <td>${s.cd || ""}</td>
          <td>${s.id ? 
            `<button class='editar' onclick="editar('${s.id}')">Editar</button>
             <button class='excluir' onclick="excluir('${s.id}')">Excluir</button>`
           : `<em>Pr√©-visualiza√ß√£o</em>`}</td>
        `;
        tabela.appendChild(tr);
      });
      totalCDs.textContent = lista.length;
    }

    function preencherFiltros() {
      const dirs = [...new Set(subordinacoes.map(s => s.diretor))].sort();
      const grcs = [...new Set(subordinacoes.map(s => s.grc))].sort();
      filtroDiretor.innerHTML = '<option value="">Todos os Diretores</option>' + dirs.map(d => `<option>${d}</option>`).join('');
      filtroGrc.innerHTML = '<option value="">Todos os GRCs</option>' + grcs.map(g => `<option>${g}</option>`).join('');
    }

    window.editar = async (id) => {
      const reg = subordinacoes.find(s => s.id === id);
      if (!reg) return toastMsg("Registro n√£o encontrado", "#d62828");
      const novoDir = prompt("Novo Diretor:", reg.diretor);
      const novoGrc = prompt("Novo GRC:", reg.grc);
      if (novoDir && novoGrc) {
        await setDoc(doc(db, "subordinacoes", id), { diretor: novoDir, grc: novoGrc, cd: reg.cd });
        toastMsg("Registro atualizado!");
        carregarSubordinacoes();
      }
    };

    window.excluir = async (id) => {
      if (!confirm("Excluir este registro?")) return;
      await deleteDoc(doc(db, "subordinacoes", id));
      subordinacoes = subordinacoes.filter(s => s.id !== id);
      atualizarTabela(subordinacoes);
      toastMsg("Registro exclu√≠do!", "#e63946");
    };

    document.getElementById("btnApagar").addEventListener("click", async () => {
      if (!confirm("Deseja realmente apagar TODOS os registros?")) return;
      const promises = subordinacoes.map(s => deleteDoc(doc(db, "subordinacoes", s.id)));
      await Promise.all(promises);
      subordinacoes = [];
      atualizarTabela([]);
      toastMsg("Todos os registros foram removidos!", "#e63946");
    });

    // VISUALIZAR EXCEL
    document.getElementById("btnVisualizar").addEventListener("click", () => {
      const file = document.getElementById("inputExcel").files[0];
      if (!file) return toastMsg("Selecione um arquivo Excel primeiro!", "#d62828");

      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);

        const normalize = str => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();

        preVisualizacao = rows.map(r => {
          const obj = {};
          for (let key in r) obj[normalize(key)] = r[key];
          const cdKey = Object.keys(obj).find(k => k.includes("cd") || k.includes("empresa") || k.includes("centro"));
          return { diretor: obj["diretor"] || "", grc: obj["grc"] || "", cd: obj[cdKey] || "" };
        });

        if (preVisualizacao.length === 0) return toastMsg("Planilha vazia!", "#d62828");
        atualizarTabela(preVisualizacao);
        acoesImport.style.display = "flex";
        toastMsg("Pr√©-visualiza√ß√£o carregada!");
      };
      reader.readAsArrayBuffer(file);
    });

    // SALVAR NO FIREBASE
    btnSalvarBanco.addEventListener("click", async () => {
      if (preVisualizacao.length === 0) return toastMsg("Nada para salvar!", "#d62828");
      progressBar.style.display = "block";
      progressFill.style.width = "0%";
      let total = preVisualizacao.length, count = 0;
      for (const r of preVisualizacao) {
        if (!r.cd) continue;
        const id = r.cd.trim().replace(/\s+/g, "_");
        await setDoc(doc(db, "subordinacoes", id), r);
        count++;
        const pct = Math.round((count / total) * 100);
        progressFill.style.width = pct + "%";
        progressFill.textContent = `Salvando ${count} de ${total} (${pct}%)`;
      }
      preVisualizacao = [];
      acoesImport.style.display = "none";
      toastMsg("Registros salvos com sucesso!");
      carregarSubordinacoes();
      setTimeout(() => {
        progressFill.style.width = "100%";
        progressFill.textContent = "Conclu√≠do ‚úÖ";
        setTimeout(() => progressBar.style.display = "none", 1500);
      }, 500);
    });

    function filtrar() {
      let lista = subordinacoes.filter(s =>
        (!filtroDiretor.value || s.diretor === filtroDiretor.value) &&
        (!filtroGrc.value || s.grc === filtroGrc.value) &&
        (!pesquisa.value || s.cd.toLowerCase().includes(pesquisa.value.toLowerCase()))
      );
      atualizarTabela(lista);
    }

    filtroDiretor.addEventListener("change", filtrar);
    filtroGrc.addEventListener("change", filtrar);
    pesquisa.addEventListener("input", filtrar);

    carregarSubordinacoes();
  </script>
</body>
</html>
