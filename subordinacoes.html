<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subordina√ß√µes 2 - Diretor / GRC / CD</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif;}
    body {
      background: #121212;
      color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 30px;
    }
    .container {
      background: #1e1e1e;
      padding: 30px;
      border-radius: 16px;
      width: 100%;
      max-width: 1100px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      position: relative;
    }
    h1 {text-align: center; color: #4cc9f0; margin-bottom: 10px;}
    .cards {display: flex; justify-content: center; margin-bottom: 20px;}
    .card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 15px 30px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .card h2 {color: #00c4ff; font-size: 2rem;}
    .card p {color: #aaa; font-size: 0.9rem;}
    .topo {
      display: flex; flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    button {
      padding: 10px 20px;
      border: none; border-radius: 8px;
      cursor: pointer; font-weight: 600;
      color: #fff; transition: 0.3s;
    }
    .importar {background: #0077b6;}
    .apagar {background: #ef233c;}
    .voltar {background: #444; margin-top: 15px;}
    button:hover {opacity: 0.9;}
    .filtros {
      display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;
      margin-bottom: 10px;
    }
    select, input[type=text] {
      background: #2a2a2a; color: #fff; border: none;
      padding: 8px 12px; border-radius: 8px;
    }
    table {width: 100%; border-collapse: collapse; margin-top: 10px;}
    th, td {padding: 10px; text-align: left; border-bottom: 1px solid #333;}
    th {background: #222; color: #00c4ff;}
    tr:hover {background: #292929;}
    td button {
      background: #00b4d8; border: none;
      padding: 6px 12px; border-radius: 6px;
      font-size: 0.8rem; color: #fff;
      margin-right: 6px;
    }
    td button.excluir {background: #ef476f;}
    .tabela-container {max-height: 500px; overflow-y: auto; margin-bottom: 20px;}
    footer {text-align: center; margin-top: 10px; color: #777; font-size: 0.8rem;}
    /* Toasts */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 12px 18px;
      border-radius: 8px;
      opacity: 0;
      pointer-events: none;
      transition: 0.4s ease;
      z-index: 999;
    }
    .toast.show {opacity: 1; pointer-events: auto; transform: translateY(0);}
    .toast.success {background: #00b894;}
    .toast.error {background: #d63031;}
  </style>
</head>

<body>
  <div class="container">
    <h1>üìã Subordina√ß√µes - Diretor / GRC / CD</h1>

    <div class="cards">
      <div class="card">
        <h2 id="totalCDs">0</h2>
        <p>Total de CDs Cadastrados</p>
      </div>
    </div>

    <div class="topo">
      <input type="file" id="inputExcel" accept=".xlsx, .xls">
      <div>
        <button class="importar" id="btnImportar">üì• Importar Excel</button>
        <button class="apagar" id="btnApagar">üóëÔ∏è Apagar Todos</button>
      </div>
    </div>

    <div class="filtros">
      <select id="filtroDiretor"><option value="">Todos os Diretores</option></select>
      <select id="filtroGrc"><option value="">Todos os GRCs</option></select>
      <input type="text" id="pesquisa" placeholder="üîç Pesquisar CD...">
    </div>

    <div class="tabela-container">
      <table>
        <thead>
          <tr>
            <th>Diretor</th>
            <th>GRC</th>
            <th>CD</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaSub"></tbody>
      </table>
    </div>

    <button class="voltar" onclick="window.location.href='index.html'">‚¨ÖÔ∏è Voltar ao Menu</button>
    <footer>¬© 2025 - Grupo Petr√≥polis | Sistema de Controle de Mochilas</footer>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, deleteDoc, doc } 
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcXTj40CI4fEJOGp2T_ghh3Wwpki4OnW0",
      authDomain: "salasdereunioes-eb91a.firebaseapp.com",
      projectId: "salasdereunioes-eb91a",
      storageBucket: "salasdereunioes-eb91a.firebasestorage.app",
      messagingSenderId: "961898084996",
      appId: "1:961898084996:web:535185ceb0860e1e06e0d1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tabela = document.getElementById("tabelaSub");
    const totalCDs = document.getElementById("totalCDs");
    const filtroDiretor = document.getElementById("filtroDiretor");
    const filtroGrc = document.getElementById("filtroGrc");
    const pesquisa = document.getElementById("pesquisa");
    const toast = document.getElementById("toast");

    let subordinacoes = [];

    function showToast(msg, type="success") {
      toast.textContent = msg;
      toast.className = `toast show ${type}`;
      setTimeout(() => toast.className = "toast", 3000);
    }

    async function carregarSubordinacoes() {
      const snap = await getDocs(collection(db, "subordinacoes"));
      subordinacoes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      atualizarTabela(subordinacoes);
      preencherFiltros();
    }

    function atualizarTabela(lista) {
      tabela.innerHTML = "";
      lista.forEach((s) => {
        const linha = document.createElement("tr");
        linha.innerHTML = `
          <td>${s.diretor}</td>
          <td>${s.grc}</td>
          <td>${s.cd}</td>
          <td>
            <button onclick="editarLinha('${s.cd}')">‚úèÔ∏è</button>
            <button class="excluir" onclick="excluirLinha('${s.cd}')">üóëÔ∏è</button>
          </td>`;
        tabela.appendChild(linha);
      });
      totalCDs.textContent = lista.length;
    }

    function preencherFiltros() {
      const diretores = [...new Set(subordinacoes.map(s => s.diretor))].sort();
      const grcs = [...new Set(subordinacoes.map(s => s.grc))].sort();
      filtroDiretor.innerHTML = '<option value="">Todos os Diretores</option>' + diretores.map(d => `<option>${d}</option>`).join('');
      filtroGrc.innerHTML = '<option value="">Todos os GRCs</option>' + grcs.map(g => `<option>${g}</option>`).join('');
    }

    window.editarLinha = async (cd) => {
      const registro = subordinacoes.find(s => s.cd === cd);
      if (!registro) return showToast("Registro n√£o encontrado.", "error");

      const novoDir = prompt("Novo Diretor:", registro.diretor);
      const novoGrc = prompt("Novo GRC:", registro.grc);
      const novoCd = prompt("Novo CD:", registro.cd);
      if (novoDir && novoGrc && novoCd) {
        const atualizado = { ...registro, diretor: novoDir, grc: novoGrc, cd: novoCd };
        await setDoc(doc(db, "subordinacoes", novoCd), atualizado);
        showToast("‚úÖ Registro atualizado!");
        carregarSubordinacoes();
      }
    };

    window.excluirLinha = async (cd) => {
      if (!confirm(`Excluir o CD ${cd}?`)) return;
      await deleteDoc(doc(db, "subordinacoes", cd));
      subordinacoes = subordinacoes.filter(s => s.cd !== cd);
      atualizarTabela(subordinacoes);
      showToast("üóëÔ∏è Registro exclu√≠do!");
    };

    document.getElementById("btnApagar").addEventListener("click", async () => {
      if (!confirm("‚ö†Ô∏è Deseja realmente apagar TODOS os registros?")) return;

      try {
        const promises = subordinacoes.filter(s => s.cd).map(s => deleteDoc(doc(db, "subordinacoes", s.cd)));
        await Promise.all(promises);
        subordinacoes = [];
        atualizarTabela([]);
        totalCDs.textContent = 0;
        showToast("üßπ Todos os registros foram removidos!");
      } catch (error) {
        console.error(error);
        showToast("‚ùå Erro ao apagar dados.", "error");
      }
    });

    document.getElementById("btnImportar").addEventListener("click", () => {
      const file = document.getElementById("inputExcel").files[0];
      if (!file) return showToast("Selecione um arquivo Excel antes de importar.", "error");

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const novosDados = XLSX.utils.sheet_to_json(sheet);

          for (const novo of novosDados) {
            if (!novo.cd) continue;
            await setDoc(doc(db, "subordinacoes", novo.cd), novo);
          }

          showToast("‚úÖ Importa√ß√£o conclu√≠da!");
          carregarSubordinacoes();
        } catch (err) {
          console.error(err);
          showToast("‚ùå Erro ao importar Excel.", "error");
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function filtrar() {
      let lista = subordinacoes.filter(s => {
        return (!filtroDiretor.value || s.diretor === filtroDiretor.value) &&
               (!filtroGrc.value || s.grc === filtroGrc.value) &&
               (!pesquisa.value || s.cd.toLowerCase().includes(pesquisa.value.toLowerCase()));
      });
      atualizarTabela(lista);
    }

    filtroDiretor.addEventListener("change", filtrar);
    filtroGrc.addEventListener("change", filtrar);
    pesquisa.addEventListener("input", filtrar);

    carregarSubordinacoes();
  </script>
</body>
</html>
